<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Color Crate Spinner (with Secrets)</title>
<style>
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(135deg,#1b1f27,#2b313f);
  color: #f0f0f0;
  text-align: center;
  padding: 30px;
}
h1 { font-weight: 700; margin-bottom: 20px; text-shadow: 0 0 6px #000; }
#spinnerContainer { position: relative; display: inline-block; padding: 10px 15px; border-radius: 16px; background: rgba(255,255,255,0.05); box-shadow: 0 6px 18px rgba(0,0,0,0.4); }
#preview { display: flex; gap: 8px; justify-content: center; margin-bottom: 28px; }
.preview-tile {
  width: 60px; height: 60px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.2);
  box-shadow: 0 2px 6px rgba(0,0,0,0.5); transition: transform 0.2s ease; position: relative; overflow: hidden;
  display:flex; align-items:center; justify-content:center;
  color:#fff; font-weight:700; font-size:0.8em; text-shadow:0 1px 4px rgba(0,0,0,0.7);
}
.preview-tile:hover { transform: scale(1.08); }
.preview-label { position:absolute; bottom:4px; left:4px; right:4px; font-size:10px; text-align:center; opacity:0.95; pointer-events:none; }
#indicator { position: absolute; bottom: -2em; left: 50%; transform: translateX(-50%); font-size: 2em; color: #ffd700; text-shadow: 0 0 10px #ffd700; pointer-events: none; }
button { padding: 10px 24px; margin: 10px; font-size: 1.1em; border-radius: 8px; border: none; background: linear-gradient(180deg,#4cafef,#2b82df); color: #fff; font-weight: 600; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: background 0.2s ease, transform 0.1s ease; }
button:hover { background: linear-gradient(180deg,#62c1ff,#3c96ef); transform: translateY(-2px); }
button:disabled { opacity: 0.4; cursor: not-allowed; }
#result { display: none; flex-direction: column; align-items: center; margin-top: 20px; background: rgba(255,255,255,0.05); padding: 10px 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
#resultTile { width: 80px; height: 80px; border-radius: 12px; border: 3px solid #fff; margin-bottom: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; text-shadow:0 1px 4px rgba(0,0,0,0.6); }
#collectNotice, #rebirthStatus { margin-top: 10px; font-style: italic; color: #ddd; }
p { margin: 8px 0; }
.rarityCounts { margin-top: 8px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
.rarityCounts span { background: rgba(255,255,255,0.03); padding:6px 10px; border-radius:8px; font-size:0.95em; color:#eaeaea; border:1px solid rgba(255,255,255,0.03); }
.note { font-size:0.9em; color:#cfcfcf; margin-top:6px; }
</style>
</head>
<body>
<h1>Color Crate Spinner</h1>

<div id="spinnerContainer">
  <div id="preview"></div>
  <div id="indicator">â–²</div>
</div>

<button id="spinBtn">ðŸŽ² Spin</button>
<p id="spinStatus"></p>

<div id="result">
  <div id="resultTile"></div>
  <div><span id="resultName"></span></div>
  <div><span id="resultRarity"></span></div>
  <div><span id="resultProb"></span></div>
</div>

<p id="collectNotice"></p>
<p>Collected: <span id="collectedCount">0</span>/<span id="storageLimit">200</span></p>

<div class="rarityCounts" id="rarityCounts">
  <span id="countCommon">Common: 0</span>
  <span id="countUncommon">Uncommon: 0</span>
  <span id="countRare">Rare: 0</span>
  <span id="countEpic">Epic: 0</span>
  <span id="countLegendary">Legendary: 0</span>
  <span id="countMythical">Mythical: 0</span>
  <span id="countSecret">Secret: 0</span>
</div>

<button id="rebirthBtn">ðŸ”„ Rebirth</button>
<p id="rebirthStatus"></p>

<p class="note">Notes: Colors show their hex code. Secret gradients are numbered (Gradient #001... #500) and each gradient individually is 1 in 10,000,000<sup>1.5</sup>.</p>

<audio id="audioSpin" preload="auto"></audio>
<audio id="audioRare" preload="auto"></audio>

<script>
// ---- Load saved data ----
let saved = JSON.parse(localStorage.getItem('colorSpinnerSave') || '{}');
let collected = new Set(saved.collected || []);
let rebirths = saved.rebirths || 0;
let storageLimit = 200 * (rebirths + 1);

const PREVIEW_TILES = 11;

// DOM refs
const previewEl = document.getElementById('preview');
const spinBtn = document.getElementById('spinBtn');
const spinStatus = document.getElementById('spinStatus');
const resultArea = document.getElementById('result');
const resultTile = document.getElementById('resultTile');
const resultName = document.getElementById('resultName');
const resultRarity = document.getElementById('resultRarity');
const resultProb = document.getElementById('resultProb');
const collectNotice = document.getElementById('collectNotice');
const collectedCountEl = document.getElementById('collectedCount');
const storageLimitEl = document.getElementById('storageLimit');
const rebirthBtn = document.getElementById('rebirthBtn');
const rebirthStatus = document.getElementById('rebirthStatus');

// rarity count elements
const cntCommon = document.getElementById('countCommon');
const cntUncommon = document.getElementById('countUncommon');
const cntRare = document.getElementById('countRare');
const cntEpic = document.getElementById('countEpic');
const cntLegendary = document.getElementById('countLegendary');
const cntMythical = document.getElementById('countMythical');
const cntSecret = document.getElementById('countSecret');

document.getElementById('collectedCount').textContent = collected.size;
document.getElementById('storageLimit').textContent = storageLimit;

// ---- Save ----
function saveGame(){
  localStorage.setItem('colorSpinnerSave', JSON.stringify({
    collected: Array.from(collected),
    rebirths: rebirths
  }));
}

// ---- helpers ----
function colorToInt(r,g,b){ return (r<<16) | (g<<8) | b; }
function seededRandom(seed){ seed = (seed * 9301 + 49297) % 233280; return seed/233280; }
function d(x){ return Math.pow(x, 1.25); }

// rarity table
const rarityTable = [
  {name:"Common", base:2},
  {name:"Uncommon", base:15},
  {name:"Rare", base:100},
  {name:"Epic", base:1000},
  {name:"Legendary", base:25000},
  {name:"Mythical", base:250000}
];

// choose rarity by weights ~ 1/denom^1.5
function rarityForColor(r,g,b){
  const int = colorToInt(r,g,b);
  const rnd = seededRandom(int);
  let weights = rarityTable.map(r => 1/d(r.base));
  let total = weights.reduce((a,b)=>a+b,0);
  let roll = rnd*total;
  for (let i=0;i<rarityTable.length;i++){
    if (roll < weights[i]){
      let denom = Math.round(d(rarityTable[i].base));
      return {denom:denom, prob:1/denom, name:rarityTable[i].name};
    }
    roll -= weights[i];
  }
  let last = rarityTable[rarityTable.length-1];
  let denom = Math.round(d(last.base));
  return {denom:denom, prob:1/denom, name:last.name};
}

// ---- Secret gradients ----
const SECRET_COUNT = 500;
const SECRET_DENOM = Math.round(Math.pow(10000000, 1.5));
const secretGradients = [];
function randHex(){ return `#${Math.floor(Math.random()*16777216).toString(16).padStart(6,'0')}`; }
for (let i=0;i<SECRET_COUNT;i++){
  const a = randHex();
  const b = randHex();
  secretGradients.push({
    id: `gradient-${i}`,
    label: `Gradient #${String(i+1).padStart(3,'0')}`,
    css: `linear-gradient(45deg, ${a}, ${b})`,
    rarityName: 'Secret',
    rarityDenom: SECRET_DENOM,
    prob: 1/SECRET_DENOM
  });
}

// ---- Item sampling ----
function sampleColorWeightedByRarity(){
  const r = Math.floor(Math.random()*256);
  const g = Math.floor(Math.random()*256);
  const b = Math.floor(Math.random()*256);
  const rarity = rarityForColor(r,g,b);
  return {type:'color', r,g,b,
    hex:`#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`,
    rarityDenom:rarity.denom, prob:rarity.prob, rarityName:rarity.name};
}

function sampleItem(){
  const roll = Math.floor(Math.random()*SECRET_DENOM);
  if (roll < SECRET_COUNT){
    return secretGradients[roll];
  }
  return sampleColorWeightedByRarity();
}

// ---- Preview ----
for(let i=0;i<PREVIEW_TILES;i++){
  const div=document.createElement('div');
  div.className='preview-tile';
  const label=document.createElement('div');
  label.className='preview-label';
  div.appendChild(label);
  previewEl.appendChild(div);
}
function refreshPreview(){
  for(let j=0;j<PREVIEW_TILES;j++){
    const it=sampleItem();
    const el=previewEl.children[j];
    const label=el.querySelector('.preview-label');
    if (it.type==='gradient'){
      el.style.background=it.css; label.textContent=it.label;
    } else {
      el.style.background=it.hex; label.textContent=it.hex;
    }
  }
}

// ---- Sounds ----
const useLocalSounds=false;
const GITHUB_SPIN_URL='https://raw.githubusercontent.com/USERNAME/REPO/BRANCH/sounds/spin.mp3';
const GITHUB_RARE_URL='https://raw.githubusercontent.com/USERNAME/REPO/BRANCH/sounds/rare.mp3';
const LOCAL_SPIN_URL='sounds/spin.mp3';
const LOCAL_RARE_URL='sounds/rare.mp3';
const audioSpin=document.getElementById('audioSpin');
const audioRare=document.getElementById('audioRare');
function setupAudioSources(){
  if(useLocalSounds){audioSpin.src=LOCAL_SPIN_URL;audioRare.src=LOCAL_RARE_URL;}
  else {audioSpin.src=GITHUB_SPIN_URL;audioRare.src=GITHUB_RARE_URL;}
}
setupAudioSources();
async function playSound(audioEl){try{if(!audioEl.src)return;audioEl.currentTime=0;await audioEl.play();}catch(e){}}

// ---- Spin ----
async function spinOnce(){
  spinBtn.disabled=true;
  spinStatus.textContent='Spinning...';
  resultArea.style.display='none';
  collectNotice.textContent='';
  playSound(audioSpin);

  const finalItem=sampleItem();
  const totalSteps=36+Math.floor(Math.random()*24);
  const currentPreview=[];
  for(let i=0;i<Math.max(PREVIEW_TILES,totalSteps)+PREVIEW_TILES;i++){
    currentPreview.push(sampleItem());
  }
  const centerIndex=Math.floor(PREVIEW_TILES/2)-1;
  const finalIndex=(totalSteps+centerIndex)%currentPreview.length;
  currentPreview[finalIndex]=finalItem;

  for(let step=0;step<totalSteps;step++){
    for(let j=0;j<PREVIEW_TILES;j++){
      const idx=(step+j)%currentPreview.length;
      const it=currentPreview[idx];
      const el=previewEl.children[j];
      const label=el.querySelector('.preview-label');
      if(it.type==='gradient'){el.style.background=it.css;label.textContent=it.label;}
      else {el.style.background=it.hex;label.textContent=it.hex;}
    }
    const t=step/totalSteps;
    const wait=8+Math.floor(120*Math.pow(t,1.8));
    await new Promise(r=>setTimeout(r,wait));
  }

  const landed=finalItem;
  if(landed.type==='gradient'){
    resultTile.style.background=landed.css;
    resultName.textContent=landed.label;
  } else {
    resultTile.style.background=landed.hex;
    resultName.textContent=landed.hex;
  }
  resultRarity.textContent=`${landed.rarityName} (1 in ${landed.rarityDenom.toLocaleString()})`;
  resultProb.textContent=(landed.prob*100).toExponential(3)+'%';
  resultArea.style.display='flex';
  spinStatus.textContent='Spin complete';
  spinBtn.disabled=false;

  if(landed.type==='gradient'||['Epic','Legendary','Mythical'].includes(landed.rarityName)){
    playSound(audioRare);
  }

  if(collected.size>=storageLimit){
    collectNotice.textContent='Storage full! Rebirth to increase capacity.';
  } else {
    let id=(landed.type==='gradient')?landed.id:landed.hex;
    if(!collected.has(id)){collected.add(id);}
    collectedCountEl.textContent=collected.size;
    saveGame();
    updateRarityCounts();
  }
}

// ---- Rebirth ----
rebirthBtn.addEventListener('click',()=>{
  const nextReq=200*(rebirths+1);
  if(collected.size>=nextReq){
    rebirths++; storageLimit=200*(rebirths+1);
    storageLimitEl.textContent=storageLimit;
    collected.clear(); collectedCountEl.textContent='0';
    rebirthStatus.textContent=`Rebirthed! New limit: ${storageLimit}`;
    saveGame(); updateRarityCounts();
  } else {rebirthStatus.textContent=`Need ${nextReq} colors to rebirth.`;}
});

// ---- Rarity counts ----
function updateRarityCounts(){
  let counts={Common:0,Uncommon:0,Rare:0,Epic:0,Legendary:0,Mythical:0,Secret:0};
  for(const key of collected){
    if(key.startsWith('gradient-')){counts.Secret++;}
    else {
      const hex=key.replace('#','');
      const r=parseInt(hex.slice(0,2),16);
      const g=parseInt(hex.slice(2,4),16);
      const b=parseInt(hex.slice(4,6),16);
      const rinfo=rarityForColor(r,g,b);
      counts[rinfo.name]++;
    }
  }
  cntCommon.textContent=`Common: ${counts.Common}`;
  cntUncommon.textContent=`Uncommon: ${counts.Uncommon}`;
  cntRare.textContent=`Rare: ${counts.Rare}`;
  cntEpic.textContent=`Epic: ${counts.Epic}`;
  cntLegendary.textContent=`Legendary: ${counts.Legendary}`;
  cntMythical.textContent=`Mythical: ${counts.Mythical}`;
  cntSecret.textContent=`Secret: ${counts.Secret}`;
}

// ---- Init ----
refreshPreview();
spinBtn.addEventListener('click',spinOnce);
updateRarityCounts();
document.getElementById('collectedCount').textContent=collected.size;
storageLimitEl.textContent=storageLimit;
</script>
</body>
</html>
